@using Serenity
@using Serenity.Web
@{
    ViewData["Title"] = "Leave Reports";
}

<div class="leave-reports-container">
    <div class="reports-header">
        <h2><i class="fa fa-file-text-o"></i> Leave Reports</h2>
    </div>

    <div class="reports-filters">
        <input type="number" id="report-employee" class="form-control" placeholder="Employee Id" />
        <input type="number" id="report-department" class="form-control" placeholder="Department Id" />
        <input type="number" id="report-leavetype" class="form-control" placeholder="Leave Type Id" />
        <input type="date" id="report-from" class="form-control" />
        <input type="date" id="report-to" class="form-control" />
        <button id="load-leave-reports" class="btn btn-primary">Load</button>
    </div>

    <div class="report-actions">
        <button id="export-history-excel" class="btn btn-success"><i class="fa fa-file-excel-o"></i> History Excel</button>
        <button id="export-dept-excel" class="btn btn-success"><i class="fa fa-file-excel-o"></i> Dept Summary Excel</button>
        <button id="export-monthly-excel" class="btn btn-success"><i class="fa fa-file-excel-o"></i> Monthly Excel</button>
        <button id="export-pdf" class="btn btn-default"><i class="fa fa-file-pdf-o"></i> PDF (Reporting Service)</button>
    </div>

    <div class="reports-grid">
        <div class="report-card">
            <h4>Leave History</h4>
            <div id="leave-history-table" class="table-wrap"></div>
        </div>
        <div class="report-card">
            <h4>Department Summary</h4>
            <div id="department-summary-table" class="table-wrap"></div>
        </div>
        <div class="report-card full-width">
            <h4>Monthly Trend</h4>
            <canvas id="monthly-report-chart" height="90"></canvas>
            <div id="monthly-summary-table" class="table-wrap mt-2"></div>
        </div>
    </div>
</div>

<style>
    .leave-reports-container { padding: 20px; }
    .reports-header { margin-bottom: 14px; }
    .reports-filters { display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)) auto; gap: 8px; margin-bottom: 12px; }
    .report-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .reports-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .report-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    .report-card.full-width { grid-column: span 2; }
    .table-wrap { max-height: 320px; overflow: auto; border: 1px solid #edf2f7; border-radius: 6px; }
    table.report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    table.report-table th, table.report-table td { border-bottom: 1px solid #eef2f7; padding: 6px 8px; text-align: left; }
    table.report-table th { background: #f8fafc; position: sticky; top: 0; }
    @@media (max-width: 1100px) { .reports-grid { grid-template-columns: 1fr; } .report-card.full-width { grid-column: span 1; } .reports-filters { grid-template-columns: 1fr 1fr; } }
</style>

<script nonce="@Html.CspNonce()">
    let monthlyChart = null;

    function getFilterRequest() {
        return {
            EmployeeId: parseInt(document.getElementById('report-employee').value || '', 10) || null,
            DepartmentId: parseInt(document.getElementById('report-department').value || '', 10) || null,
            LeaveTypeId: parseInt(document.getElementById('report-leavetype').value || '', 10) || null,
            DateFrom: document.getElementById('report-from').value || null,
            DateTo: document.getElementById('report-to').value || null
        };
    }

    function renderTable(containerId, columns, rows) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!rows || rows.length === 0) {
            container.innerHTML = '<div style="padding:10px;color:#6b7280;">No data found.</div>';
            return;
        }

        let html = '<table class="report-table"><thead><tr>';
        columns.forEach(c => html += '<th>' + c.title + '</th>');
        html += '</tr></thead><tbody>';
        rows.forEach(r => {
            html += '<tr>';
            columns.forEach(c => {
                let val = r[c.field];
                if (val === null || val === undefined) val = '';
                html += '<td>' + val + '</td>';
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderMonthlyChart(rows) {
        const labels = (rows || []).map(x => x.MonthLabel);
        const values = (rows || []).map(x => x.TotalLeaves || 0);
        const canvas = document.getElementById('monthly-report-chart');
        if (!canvas) return;

        if (monthlyChart)
            monthlyChart.destroy();

        monthlyChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Total Leave Days', data: values, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.2)', fill: true }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }

    function loadReports() {
        const req = getFilterRequest();

        Q.serviceRequest('Operations/LeaveReports/LeaveHistory', req, function (res) {
            renderTable('leave-history-table', [
                { title: 'App No', field: 'LeaveApplicationNo' },
                { title: 'Employee', field: 'EmployeeName' },
                { title: 'Type', field: 'LeaveTypeName' },
                { title: 'From', field: 'StartDate' },
                { title: 'To', field: 'EndDate' },
                { title: 'Total', field: 'TotalDays' },
                { title: 'Paid', field: 'PaidDays' },
                { title: 'Unpaid', field: 'UnpaidDays' }
            ], res.Entities || []);
        });

        Q.serviceRequest('Operations/LeaveReports/DepartmentSummary', req, function (res) {
            renderTable('department-summary-table', [
                { title: 'Department', field: 'DepartmentName' },
                { title: 'Total', field: 'TotalLeaves' },
                { title: 'Paid', field: 'PaidDays' },
                { title: 'Unpaid', field: 'UnpaidDays' },
                { title: 'Pending', field: 'PendingCount' }
            ], res.Entities || []);
        });

        Q.serviceRequest('Operations/LeaveReports/MonthlySummary', req, function (res) {
            const rows = res.Entities || [];
            renderMonthlyChart(rows);
            renderTable('monthly-summary-table', [
                { title: 'Month', field: 'MonthLabel' },
                { title: 'Total', field: 'TotalLeaves' },
                { title: 'Paid', field: 'PaidDays' },
                { title: 'Unpaid', field: 'UnpaidDays' }
            ], rows);
        });
    }

    function postDownload(url, request) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = Q.resolveUrl('~/Services/' + url);
        const req = request || {};
        Object.keys(req).forEach(function (k) {
            if (req[k] === null || req[k] === undefined || req[k] === '')
                return;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = k;
            input.value = req[k];
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadReports();
        document.getElementById('load-leave-reports').addEventListener('click', loadReports);
        document.getElementById('export-history-excel').addEventListener('click', function () { postDownload('Operations/LeaveReports/LeaveHistoryExcel', getFilterRequest()); });
        document.getElementById('export-dept-excel').addEventListener('click', function () { postDownload('Operations/LeaveReports/DepartmentSummaryExcel', getFilterRequest()); });
        document.getElementById('export-monthly-excel').addEventListener('click', function () { postDownload('Operations/LeaveReports/MonthlySummaryExcel', getFilterRequest()); });
        document.getElementById('export-pdf').addEventListener('click', function () {
            Q.notifyInfo('PDF is routed through Serenity reporting service and needs report template keys for final output wiring.');
        });
    });
</script>
